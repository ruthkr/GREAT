---
title: "Running registration using real data with different timepoints"
output: 
  github_document:
    toc: true
---

## Set-up and load libraries

```{r setup}
knitr::opts_chunk$set()

devtools::load_all()
library(ggplot2)
library(data.table)
library(cowplot)
library(ggpubr)
```

## Run GREAT main function using subset of Alex's rapa data

```{r}
# Load data obtained from Ruth's refactored function
path_b_rapa <- "~/Downloads/test_data.RDS"

alex_data_mean <- readRDS(path_b_rapa)[[1]]
alex_data_all <- readRDS(path_b_rapa)[[2]]
```

### Plot data before registering

```{r, warning=FALSE, fig.width=10, fig.height=10}
ggplot() +
  aes(x = timepoint, y = mean_cpm, color = accession) +
  geom_line(data = alex_data_mean) +
  geom_point(data = alex_data_mean) +
  facet_wrap(~locus_name)
```


### Register data

```{r}
test_using_brapa_data <- GREAT::scale_and_register_data(
  alex_data_mean,
  alex_data_all,
  stretches =  c(2, 1.5, 1),
  shift_extreme = 4,
  num_shifts = 27,
  min_num_overlapping_points = 4,
  initial_rescale = FALSE,
  do_rescale = TRUE,
  testing = FALSE,
  accession_data_to_transform = "Col0",
  accession_data_fix = "Ro18",
  data_to_transform_time_added = 11,
  data_fix_time_added = 11
)
```

### Plot data after registration

```{r, warning=FALSE, fig.width=10, fig.height=10}
id_table_path <- system.file("extdata/sample_data/id_table_5genes.RDS", package = "GREAT")

ID_table <- readRDS(id_table_path)

test_mapped <- test_using_brapa_data[['imputed_mean_df']] %>%
  dplyr::left_join(ID_table %>% 
                     dplyr::mutate(CDS.model = toupper(CDS.model)), by = c("locus_name" = "CDS.model")) %>% 
  dplyr::select(-c(locus_name.y)) %>%
  dplyr::rename(locus_name = symbol, bra_gene = locus_name)

data_to_plot <- test_mapped %>% 
  dplyr::filter(dplyr::case_when(locus_name == "AGL24" ~ shifted_time >= 14 & shifted_time <= 35, 
                          locus_name == "AP1" ~  shifted_time >= 11 & shifted_time <= 25,
                          locus_name == "AP3" ~  shifted_time >= 11 & shifted_time <= 30,
                          locus_name == "LFY" ~ shifted_time >= 11 & shifted_time <= 26,
                          locus_name == "SOC1" ~ shifted_time >= 10 & shifted_time <= 31))


# Function to map ara and bra genes
map_bra_with_ara_genes <- function(bra_data, ara_table){
  
  mapped_data <- bra_data %>% 
    dplyr::left_join(ara_table %>% 
                     dplyr::mutate(CDS.model = toupper(CDS.model)), by = c("locus_name" = "CDS.model")) %>% 
  dplyr::select(-c(locus_name.y)) %>%
  dplyr::rename(locus_name = symbol, bra_gene = locus_name)
  
  return(mapped_data)

}

GREAT::plot_registered_GoIs_for_comparible_timepoints(data_to_plot)
```

## Slice the data functions

```{r}
list_genes <- alex_data_mean %>% 
  dplyr::pull(locus_name) %>% 
  unique()

list_genes
```

```{r}
slice_data_timepoints <- function(data, gene_accession, num_timepoints){
  
  sliced_data <- data %>% 
    dplyr::filter(locus_name == gene_accession & accession == "Ro18") %>% 
    dplyr::arrange(timepoint) %>% 
    dplyr::slice(1:num_timepoints) %>% 
    dplyr::bind_rows(
      data %>% 
      dplyr::filter(locus_name == gene_accession & accession == "Col0") %>% 
      dplyr::arrange(timepoint) %>% 
      dplyr::slice(1:num_timepoints)
    )
  
  return(sliced_data)
}

alex_data_mean %>% 
    dplyr::filter(locus_name == "BRAA02G018970.3C" & accession == "Ro18") %>% 
    dplyr::arrange(timepoint) %>% 
    dplyr::slice(1:10)


slice_data_timepoints(alex_data_mean, "BRAA02G018970.3C", 10)
```



## Data with 10 points

### Plot data before registering

```{r, warning=FALSE, fig.width=10, fig.height=10}
data_with_10_timepoints_mean <- list_genes %>% 
  purrr::map(~ slice_data_timepoints(alex_data_mean, .x, 10)) %>% 
  purrr::reduce(dplyr::bind_rows)

# data_with_10_timepoints_mean

data_with_10_timepoints_mean %>% 
ggplot() +
  aes(x = timepoint, y = mean_cpm, color = accession) +
  geom_line(data = data_with_10_timepoints_mean) +
  geom_point(data = data_with_10_timepoints_mean) +
  facet_wrap(~locus_name)
```

```{r}
get_bra_timepoint <- function(data){
  list <- data %>% 
  dplyr::filter(accession == "Ro18") %>% 
  dplyr::pull(timepoint) %>% 
  unique()
  
  return(list)
}

get_ara_timepoint <- function(data){
  list <- data %>% 
  dplyr::filter(accession == "Col0") %>% 
  dplyr::pull(timepoint) %>% 
  unique()
  
  return(list)
}

data_with_10_timepoints_all <- dplyr::bind_rows(alex_data_all %>% 
  dplyr::filter(accession == "Ro18" & timepoint %in% get_bra_timepoint(data_with_10_timepoints_mean)),
  alex_data_all %>% 
  dplyr::filter(accession == "Col0" & timepoint %in% get_ara_timepoint(data_with_10_timepoints_mean))
  )

data_with_10_timepoints_all
```

### Register data

```{r message=FALSE}
reg_data_with_10_timepoints <- GREAT::scale_and_register_data(
  data_with_10_timepoints_mean,
  data_with_10_timepoints_all,
  stretches =  c(2, 1.5, 1),
  shift_extreme = 4,
  num_shifts = 27,
  min_num_overlapping_points = 4,
  initial_rescale = FALSE,
  do_rescale = TRUE,
  testing = FALSE,
  accession_data_to_transform = "Col0",
  accession_data_fix = "Ro18",
  data_to_transform_time_added = 11,
  data_fix_time_added = 11
)
```

```{r, warning=FALSE, fig.width=10, fig.height=10}
GREAT::plot_registered_GoIs_for_comparible_timepoints(reg_data_with_10_timepoints[['imputed_mean_df']])
```


## Data with 9 points

### Plot data before registering

```{r, warning=FALSE, fig.width=10, fig.height=10}
data_with_9_timepoints_mean <- list_genes %>% 
  purrr::map(~ slice_data_timepoints(alex_data_mean, .x, 9)) %>% 
  purrr::reduce(dplyr::bind_rows)


ggplot() +
  aes(x = timepoint, y = mean_cpm, color = accession) +
  geom_line(data = data_with_9_timepoints_mean) +
  geom_point(data = data_with_9_timepoints_mean) +
  facet_wrap(~locus_name)
```

```{r}
data_with_9_timepoints_all <- dplyr::bind_rows(alex_data_all %>% 
  dplyr::filter(accession == "Ro18" & timepoint %in% get_bra_timepoint(data_with_9_timepoints_mean)),
  alex_data_all %>% 
  dplyr::filter(accession == "Col0" & timepoint %in% get_ara_timepoint(data_with_9_timepoints_mean))
  )

data_with_9_timepoints_all

 get_bra_timepoint(data_with_9_timepoints_mean)
```

### Register data

```{r message=FALSE}
reg_data_with_9_timepoints <- GREAT::scale_and_register_data(
  data_with_9_timepoints_mean,
  data_with_9_timepoints_all,
  stretches =  c(2, 1.5, 1),
  shift_extreme = 4,
  num_shifts = 27,
  min_num_overlapping_points = 4,
  initial_rescale = FALSE,
  do_rescale = TRUE,
  testing = FALSE,
  accession_data_to_transform = "Col0",
  accession_data_fix = "Ro18",
  data_to_transform_time_added = 11,
  data_fix_time_added = 11
)
```

```{r, warning=FALSE, fig.width=10, fig.height=10}
GREAT::plot_registered_GoIs_for_comparible_timepoints(reg_data_with_9_timepoints[['imputed_mean_df']])
```


## Data with 8 points

### Plot data before registering

```{r, warning=FALSE, fig.width=10, fig.height=10}
data_with_8_timepoints_mean <- list_genes %>% 
  purrr::map(~ slice_data_timepoints(alex_data_mean, .x, 8)) %>% 
  purrr::reduce(dplyr::bind_rows)

ggplot() +
  aes(x = timepoint, y = mean_cpm, color = accession) +
  geom_line(data = data_with_8_timepoints_mean) +
  geom_point(data = data_with_8_timepoints_mean) +
  facet_wrap(~locus_name)
```

```{r}
data_with_8_timepoints_all <- dplyr::bind_rows(alex_data_all %>% 
  dplyr::filter(accession == "Ro18" & timepoint %in% get_bra_timepoint(data_with_8_timepoints_mean)),
  alex_data_all %>% 
  dplyr::filter(accession == "Col0" & timepoint %in% get_ara_timepoint(data_with_8_timepoints_mean))
  )
get_bra_timepoint(data_with_8_timepoints_mean)
```

### Register data

```{r message=FALSE}
reg_data_with_8_timepoints <- GREAT::scale_and_register_data(
  data_with_8_timepoints_mean,
  data_with_8_timepoints_all,
  stretches =  c(2, 1.5, 1),
  shift_extreme = 4,
  num_shifts = 27,
  min_num_overlapping_points = 4,
  initial_rescale = FALSE,
  do_rescale = TRUE,
  testing = FALSE,
  accession_data_to_transform = "Col0",
  accession_data_fix = "Ro18",
  data_to_transform_time_added = 11,
  data_fix_time_added = 11
)
```

```{r, warning=FALSE, fig.width=10, fig.height=10}
GREAT::plot_registered_GoIs_for_comparible_timepoints(reg_data_with_8_timepoints[['imputed_mean_df']])
```


## Data with 7 points

### Plot data before registering

```{r, warning=FALSE, fig.width=10, fig.height=10}
data_with_7_timepoints_mean <- list_genes %>% 
  purrr::map(~ slice_data_timepoints(alex_data_mean, .x, 7)) %>% 
  purrr::reduce(dplyr::bind_rows)

ggplot() +
  aes(x = timepoint, y = mean_cpm, color = accession) +
  geom_line(data = data_with_7_timepoints_mean) +
  geom_point(data = data_with_7_timepoints_mean) +
  facet_wrap(~locus_name)
```

```{r}
data_with_7_timepoints_all <- dplyr::bind_rows(alex_data_all %>% 
  dplyr::filter(accession == "Ro18" & timepoint %in% get_bra_timepoint(data_with_7_timepoints_mean)),
  alex_data_all %>% 
  dplyr::filter(accession == "Col0" & timepoint %in% get_ara_timepoint(data_with_7_timepoints_mean))
  )
get_bra_timepoint(data_with_7_timepoints_mean)
```

### Register data

```{r message=FALSE}
reg_data_with_7_timepoints <- GREAT::scale_and_register_data(
  data_with_7_timepoints_mean,
  data_with_7_timepoints_all,
  stretches =  c(2, 1.5, 1),
  shift_extreme = 4,
  num_shifts = 27,
  min_num_overlapping_points = 2,
  initial_rescale = FALSE,
  do_rescale = TRUE,
  testing = FALSE,
  accession_data_to_transform = "Col0",
  accession_data_fix = "Ro18",
  data_to_transform_time_added = 11,
  data_fix_time_added = 11
)
```

```{r, warning=FALSE, fig.width=10, fig.height=10}
GREAT::plot_registered_GoIs_for_comparible_timepoints(reg_data_with_7_timepoints[['imputed_mean_df']])
```


## Data with 6 points

### Plot data before registering

```{r, warning=FALSE, fig.width=10, fig.height=10}
data_with_6_timepoints_mean <- list_genes %>% 
  purrr::map(~ slice_data_timepoints(alex_data_mean, .x, 6)) %>% 
  purrr::reduce(dplyr::bind_rows)

ggplot() +
  aes(x = timepoint, y = mean_cpm, color = accession) +
  geom_line(data = data_with_6_timepoints_mean) +
  geom_point(data = data_with_6_timepoints_mean) +
  facet_wrap(~locus_name, scales = "free_y")
```

```{r}
data_with_6_timepoints_all <- dplyr::bind_rows(alex_data_all %>% 
  dplyr::filter(accession == "Ro18" & timepoint %in% get_bra_timepoint(data_with_6_timepoints_mean)),
  alex_data_all %>% 
  dplyr::filter(accession == "Col0" & timepoint %in% get_ara_timepoint(data_with_6_timepoints_mean))
  )
```

```{r eval=FALSE, fig.width=15, include=FALSE}
data_with_6_timepoints_all %>% 
  dplyr::rowwise() %>% 
  dplyr::mutate(group = stringr::str_sub(group, -1, -1)) %>%
  # dplyr::mutate(group = gsub('[[:digit:]]+', '', group)) %>% 
  ggplot() + 
  aes(x = timepoint, y = mean_cpm, color = accession, group = interaction(accession, group), linetype = group) +
  geom_point() +
  geom_line() +
  facet_wrap(~locus_name, scales = "free_y")

data_with_6_timepoints_all
```

### Register data

```{r message=FALSE}
reg_data_with_6_timepoints <- GREAT::scale_and_register_data(
  data_with_6_timepoints_mean,
  data_with_6_timepoints_all,
  stretches =  c(2, 1.5, 1),
  shift_extreme = 4,
  num_shifts = 27,
  min_num_overlapping_points = 4,
  initial_rescale = FALSE,
  do_rescale = TRUE,
  testing = FALSE,
  accession_data_to_transform = "Col0",
  accession_data_fix = "Ro18",
  data_to_transform_time_added = 11,
  data_fix_time_added = 11
)
```

```{r, warning=FALSE, fig.width=10, fig.height=10}
GREAT::plot_registered_GoIs_for_comparible_timepoints(reg_data_with_6_timepoints[['imputed_mean_df']])
```

## Data with 5 points

### Plot data before registering

```{r, warning=FALSE, fig.width=10, fig.height=10}
data_with_5_timepoints_mean <- list_genes %>% 
  purrr::map(~ slice_data_timepoints(alex_data_mean, .x, 5)) %>% 
  purrr::reduce(dplyr::bind_rows)

ggplot() +
  aes(x = timepoint, y = mean_cpm, color = accession) +
  geom_line(data = data_with_5_timepoints_mean) +
  geom_point(data = data_with_5_timepoints_mean) +
  facet_wrap(~locus_name)
```

```{r}
data_with_5_timepoints_all <- dplyr::bind_rows(alex_data_all %>% 
  dplyr::filter(accession == "Ro18" & timepoint %in% get_bra_timepoint(data_with_5_timepoints_mean)),
  alex_data_all %>% 
  dplyr::filter(accession == "Col0" & timepoint %in% get_ara_timepoint(data_with_5_timepoints_mean))
  )

get_bra_timepoint(data_with_5_timepoints_mean)
```

### Register data

```{r message=FALSE}
reg_data_with_5_timepoints <- GREAT::scale_and_register_data(
  data_with_5_timepoints_mean,
  data_with_5_timepoints_all,
  stretches =  c(2, 1.5, 1),
  shift_extreme = 4,
  num_shifts = 27,
  min_num_overlapping_points = 2,
  initial_rescale = FALSE,
  do_rescale = TRUE,
  testing = FALSE,
  accession_data_to_transform = "Col0",
  accession_data_fix = "Ro18",
  data_to_transform_time_added = 11,
  data_fix_time_added = 11
)
```

```{r, warning=FALSE, fig.width=10, fig.height=10}
GREAT::plot_registered_GoIs_for_comparible_timepoints(reg_data_with_5_timepoints[['imputed_mean_df']])
```


## Data with 4 points

### Plot data before registering

```{r, warning=FALSE, fig.width=10, fig.height=10}
data_with_4_timepoints_mean <- list_genes %>% 
  purrr::map(~ slice_data_timepoints(alex_data_mean, .x, 4)) %>% 
  purrr::reduce(dplyr::bind_rows)

ggplot() +
  aes(x = timepoint, y = mean_cpm, color = accession) +
  geom_line(data = data_with_4_timepoints_mean) +
  geom_point(data = data_with_4_timepoints_mean) +
  facet_wrap(~locus_name)
```
```{r}
data_with_4_timepoints_all <- dplyr::bind_rows(alex_data_all %>% 
  dplyr::filter(accession == "Ro18" & timepoint %in% get_bra_timepoint(data_with_4_timepoints_mean)),
  alex_data_all %>% 
  dplyr::filter(accession == "Col0" & timepoint %in% get_ara_timepoint(data_with_4_timepoints_mean))
  )

get_bra_timepoint(data_with_4_timepoints_mean)
```

### Register data

```{r message=FALSE}
reg_data_with_4_timepoints <- GREAT::scale_and_register_data(
  data_with_4_timepoints_mean,
  data_with_4_timepoints_all,
  stretches =  c(2, 1.5, 1),
  shift_extreme = 4,
  num_shifts = 27,
  min_num_overlapping_points = 2,
  initial_rescale = FALSE,
  do_rescale = TRUE,
  testing = FALSE,
  accession_data_to_transform = "Col0",
  accession_data_fix = "Ro18",
  data_to_transform_time_added = 11,
  data_fix_time_added = 11
)
```


```{r, warning=FALSE, fig.width=10, fig.height=10}
GREAT::plot_registered_GoIs_for_comparible_timepoints(reg_data_with_4_timepoints[['imputed_mean_df']])
```





