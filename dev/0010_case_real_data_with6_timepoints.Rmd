---
title: "Running registration using real data with different timepoints"
output: 
  github_document:
    toc: true
---


## Setup and running functions

```{r setup}
knitr::opts_chunk$set()

devtools::load_all()
library(ggplot2)
library(data.table)
library(cowplot)
library(ggpubr)
```

```{r, warning=FALSE, fig.width=10, fig.height=10}
id_table_path <- system.file("extdata/sample_data/id_table_5genes.RDS", package = "GREAT")

ID_table <- readRDS(id_table_path)

# Function to map ara and bra genes
map_bra_with_ara_genes <- function(bra_data, ara_table){
  
  mapped_data <- bra_data %>% 
    dplyr::left_join(ara_table %>% 
                     dplyr::mutate(CDS.model = toupper(CDS.model)), by = c("locus_name" = "CDS.model")) %>% 
  dplyr::select(-c(locus_name.y)) %>%
  dplyr::rename(locus_name = symbol, bra_gene = locus_name)
  
  return(mapped_data)

}

# Functions to slice data
slice_data_timepoints <- function(data, gene_accession, num_timepoints){
  
  sliced_data <- data %>% 
    dplyr::filter(locus_name == gene_accession & accession == "Ro18") %>% 
    dplyr::arrange(timepoint) %>% 
    dplyr::slice(1:num_timepoints) %>% 
    dplyr::bind_rows(
      data %>% 
      dplyr::filter(locus_name == gene_accession & accession == "Col0") %>% 
      dplyr::arrange(timepoint) %>% 
      dplyr::slice(1:num_timepoints)
    )
  
  return(sliced_data)
}

get_bra_timepoint <- function(data){
  list <- data %>% 
  dplyr::filter(accession == "Ro18") %>% 
  dplyr::pull(timepoint) %>% 
  unique()
  
  return(list)
}

get_ara_timepoint <- function(data){
  list <- data %>% 
  dplyr::filter(accession == "Col0") %>% 
  dplyr::pull(timepoint) %>% 
  unique()
  
  return(list)
}


```


## Run GREAT main function using subset of Alex's rapa data

```{r}
# Load data obtained from Ruth's refactored function
path_b_rapa <- "~/Downloads/test_data.RDS"

alex_data_mean <- readRDS(path_b_rapa)[[1]]
alex_data_all <- readRDS(path_b_rapa)[[2]]

list_genes <- alex_data_mean %>% 
  dplyr::pull(locus_name) %>% 
  unique()

list_genes
```

### Plot original mean data

```{r plot-data-ori, warning=FALSE, fig.width=10, fig.height=10}
ggplot() +
  aes(x = timepoint, y = mean_cpm, color = accession) +
  geom_line(data = alex_data_mean) +
  geom_point(data = alex_data_mean) +
  facet_wrap(~locus_name, scales = "free_y")
```


## Case studies for data n = 6

### Plot mean data before registering

```{r plot-data-mean-n6, warning=FALSE, fig.width=10, fig.height=10}
# Get data with timepoint n = 6
data_with_6_timepoints_mean <- list_genes %>% 
  purrr::map(~ slice_data_timepoints(alex_data_mean, .x, 6)) %>% 
  purrr::reduce(dplyr::bind_rows)

ggplot() +
  aes(x = timepoint, y = mean_cpm, color = accession) +
  geom_line(data = data_with_6_timepoints_mean) +
  geom_point(data = data_with_6_timepoints_mean) +
  facet_wrap(~locus_name, scales = "free_y")
```

### Plot all data before registering

```{r plot-data-all-n6, fig.width=10, fig.height=10}
data_with_6_timepoints_all <- dplyr::bind_rows(alex_data_all %>% 
  dplyr::filter(accession == "Ro18" & timepoint %in% get_bra_timepoint(data_with_6_timepoints_mean)),
  alex_data_all %>% 
  dplyr::filter(accession == "Col0" & timepoint %in% get_ara_timepoint(data_with_6_timepoints_mean))
  )

data_with_6_timepoints_all %>% 
  dplyr::rowwise() %>% 
  dplyr::mutate(group = stringr::str_sub(group, -1, -1)) %>%
  ggplot() + 
  aes(x = timepoint, y = mean_cpm, color = accession, group = interaction(accession, group), linetype = group) +
  geom_point() +
  geom_line() +
  facet_wrap(~locus_name, scales = "free_y")
```

### Register data using mean and all data

```{r echo=TRUE}
reg_data_with_6_timepoints_mixed <- GREAT::scale_and_register_data(
  data_with_6_timepoints_mean,
  data_with_6_timepoints_all,
  stretches =  c(2, 1.5, 1),
  shift_extreme = 4,
  num_shifts = 27,
  min_num_overlapping_points = 4,
  initial_rescale = FALSE,
  do_rescale = TRUE,
  testing = FALSE,
  accession_data_to_transform = "Col0",
  accession_data_fix = "Ro18",
  data_to_transform_time_added = 11,
  data_fix_time_added = 11
)
```

```{r plot-data-mixed-n6-after-reg, warning=FALSE, fig.width=10, fig.height=10}
GREAT::plot_registered_GoIs_for_comparible_timepoints(reg_data_with_6_timepoints_mixed[['imputed_mean_df']])
```

```{r}
reg_data_with_6_timepoints_mixed[['model_comparison_dt']] %>% 
  dplyr::select(gene, BIC_registered_is_better, ABIC_registered_is_better) %>% 
  knitr::kable()
```

### Register data using only mean data

```{r echo=TRUE}
reg_data_with_6_timepoints_mean <- GREAT::scale_and_register_data(
  data_with_6_timepoints_mean,
  data_with_6_timepoints_mean,
  stretches =  c(2, 1.5, 1),
  shift_extreme = 4,
  num_shifts = 27,
  min_num_overlapping_points = 4,
  initial_rescale = FALSE,
  do_rescale = TRUE,
  testing = FALSE,
  accession_data_to_transform = "Col0",
  accession_data_fix = "Ro18",
  data_to_transform_time_added = 11,
  data_fix_time_added = 11
)
```

```{r plot-data-mean-n6-after-reg, warning = FALSE, fig.width=10, fig.height=10}
GREAT::plot_registered_GoIs_for_comparible_timepoints(reg_data_with_6_timepoints_mean[['imputed_mean_df']])
```


```{r}
reg_data_with_6_timepoints_mean[['model_comparison_dt']] %>% 
  dplyr::select(gene, BIC_registered_is_better, ABIC_registered_is_better) %>% 
  knitr::kable()
```

### Compare data fitting for mean data and all data

#### BRAA06G025360.3C with maximum shifted_time = 16

```{r BRAA06G025360.3C_16, echo=FALSE, fig.cap="BRAA06G025360.3C with max shifted time = 16", out.width = '50%'}
knitr::include_graphics("0010_case_real_data_with6_timepoints_files/figure-ext/BRAA06G025360.3C_16_mean.png")
```

```{r BRAA06G025360.3C_16_mixed, echo=FALSE, fig.cap="BRAA06G0253 60.3C with max shifted time = 16", out.width = '50%'}
knitr::include_graphics("0010_case_real_data_with6_timepoints_files/figure-ext/BRAA06G025360.3C_16_mixed.png")
```


#### BRAA06G025360.3C with maximum shifted_time = 17

```{r BRAA06G025360.3C_17, echo=FALSE, fig.cap="BRAA06G025360.3C with max shifted time = 17", out.width = '50%'}
knitr::include_graphics("0010_case_real_data_with6_timepoints_files/figure-ext/BRAA06G025360.3C_17_mean.png")
```


```{r BRAA06G025360.3C_17_mixed, echo=FALSE, fig.cap="BRAA06G0253 60.3C with max shifted time = 17", out.width = '50%'}
knitr::include_graphics("0010_case_real_data_with6_timepoints_files/figure-ext/BRAA06G025360.3C_17_mixed.png")
```

There are two possibilities of data:

```{r user_data, echo=FALSE, fig.cap="User input data", out.width = '75%'}
knitr::include_graphics("0010_case_real_data_with6_timepoints_files/figure-ext/user_input_data_possibilities.png")
```



#### Aux codes

```r
# Filter Alex's rapa data with 6 timepoints containing all biological reps

data_with_6_timepoints_all %>% 
  dplyr::filter(locus_name == "BRAA06G025360.3C") %>% 
  dplyr::rowwise() %>% 
  dplyr::mutate(group = stringr::str_sub(group, -1, -1)) %>% 
  ggplot() + 
  aes(x = timepoint, y = mean_cpm, color = group) +
  geom_point() +
  geom_line() +
  facet_wrap(~ accession)
```

```r
data_with_6_timepoints_all %>% 
  dplyr::filter(locus_name == "BRAA06G025360.3C" & accession == "Col0") %>% 
  dplyr::arrange(timepoint) %>% 
  knitr::kable()
```

```r
shifted_data <- apply_best_shift(data = data_with_6_timepoints_all %>% 
  dplyr::filter(locus_name == "BRAA06G025360.3C"),
                                          reg_data_with_6_timepoints[['model_comparison_dt']],
                                          accession_data_to_transform = "Col0",
                                          accession_data_fix = "Ro18",
                                          data_to_transform_time_added = 11,
                                          data_fix_time_added = 11)

data_ara_after_before_reg <- apply_best_shift(data = data_with_6_timepoints_all %>% 
  dplyr::filter(locus_name == "BRAA06G025360.3C"),
                                          reg_data_with_6_timepoints[['model_comparison_dt']],
                                          accession_data_to_transform = "Col0",
                                          accession_data_fix = "Ro18",
                                          data_to_transform_time_added = 11,
                                          data_fix_time_added = 11) %>% 
  dplyr::filter(accession == "Col0") %>% 
  dplyr::select(mean_cpm, original_time = timepoint, shifted_time, group) %>% 
  dplyr::rowwise() %>% 
  dplyr::mutate(group = stringr::str_sub(group, -1, -1)) %>% 
  tidyr::pivot_longer(!c(mean_cpm, group), names_to = "group_timepoint", values_to = "timepoint")

data_ara_after_before_reg %>% 
  ggplot() + 
  aes(x = timepoint, y = mean_cpm, color = group_timepoint) +
  geom_point() +
  geom_line() +
  facet_wrap(~ group)
```

```r
get_compared_timepoints(data = shifted_data,
                                    accession_data_to_transform = "Col0",
                                    accession_data_fix = "Ro18")


compare_registered_to_unregistered_model("BRAA06G025360.3C",
  shifted_data,
  is_testing = TRUE,
  accession_data_to_transform = "Col0",
  accession_data_fix = "Ro18"
)
```


```r
calculate_all_model_comparison_stats(all_data_df = data_with_6_timepoints_all %>% 
  dplyr::filter(locus_name == "BRAA06G025360.3C"),
                                          reg_data_with_6_timepoints[['model_comparison_dt']],
                                          accession_data_to_transform = "Col0",
                                          accession_data_fix = "Ro18",
                                          data_to_transform_time_added = 11,
                                          data_fix_time_added = 11)


data_with_6_timepoints_all %>% 
  dplyr::filter(locus_name == "BRAA06G025360.3C")
```



