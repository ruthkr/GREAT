---
title: "Running registration using real data with missing timepoints"
output: 
  github_document:
    toc: true
---

## Set-up and load libraries

```{r setup}
knitr::opts_chunk$set()

devtools::load_all()
library(ggplot2)
library(data.table)
library(cowplot)
library(ggpubr)
```

## Run GREAT main function using subset of Alex's rapa data

```{r}
# Load data obtained from Ruth's refactored function
path_b_rapa <- "~/Downloads/test_data.RDS"

alex_data_mean <- readRDS(path_b_rapa)[[1]]
alex_data_all <- readRDS(path_b_rapa)[[2]]


alex_data_all %>% 
  mutate(
    group_simplified = as.factor(unlist(stringr::str_extract_all(group, pattern = "[a-d]$")))
  ) %>% 
  ggplot() +
  aes(x = timepoint, y = mean_cpm, colour = group_simplified) +
  geom_point() +
  facet_wrap(accession~locus_name, scales = "free")
```

### Plot data before registering

```{r, warning=FALSE, fig.width=10, fig.height=10}
ggplot() +
  aes(x = timepoint, y = mean_cpm, color = accession) +
  geom_line(data = alex_data_mean) +
  geom_point(data = alex_data_mean) +
  facet_wrap(~locus_name)
```


### Register data

```{r}
test_using_brapa_data <- GREAT::scale_and_register_data(
  alex_data_mean,
  alex_data_all,
  stretches =  c(2, 1.5, 1),
  shift_extreme = 4,
  num_shifts = 27,
  min_num_overlapping_points = 4,
  initial_rescale = FALSE,
  do_rescale = TRUE,
  testing = FALSE,
  accession_data_to_transform = "Col0",
  accession_data_fix = "Ro18",
  data_to_transform_time_added = 11,
  data_fix_time_added = 11
)
```

### Plot data after registration

```{r, warning=FALSE, fig.width=10, fig.height=10}
id_table_path <- system.file("extdata/sample_data/id_table_5genes.RDS", package = "GREAT")

ID_table <- readRDS(id_table_path)

test_mapped <- test_using_brapa_data[['imputed_mean_df']] %>%
  dplyr::left_join(ID_table %>% 
                     dplyr::mutate(CDS.model = toupper(CDS.model)), by = c("locus_name" = "CDS.model")) %>% 
  dplyr::select(-c(locus_name.y)) %>%
  dplyr::rename(locus_name = symbol, bra_gene = locus_name)

data_to_plot <- test_mapped %>% 
  dplyr::filter(dplyr::case_when(locus_name == "AGL24" ~ shifted_time >= 14 & shifted_time <= 35, 
                          locus_name == "AP1" ~  shifted_time >= 11 & shifted_time <= 25,
                          locus_name == "AP3" ~  shifted_time >= 11 & shifted_time <= 30,
                          locus_name == "LFY" ~ shifted_time >= 11 & shifted_time <= 26,
                          locus_name == "SOC1" ~ shifted_time >= 10 & shifted_time <= 31))


# Function to map ara and bra genes
map_bra_with_ara_genes <- function(bra_data, ara_table){
  
  mapped_data <- bra_data %>% 
    dplyr::left_join(ara_table %>% 
                     dplyr::mutate(CDS.model = toupper(CDS.model)), by = c("locus_name" = "CDS.model")) %>% 
  dplyr::select(-c(locus_name.y)) %>%
  dplyr::rename(locus_name = symbol, bra_gene = locus_name)
  
  return(mapped_data)

}

GREAT::plot_registered_GoIs_for_comparible_timepoints(data_to_plot)
```

## Slice the data functions

```{r fn-undersample-data_timepoints-skip}
undersample_data_timepoints_skip <- function(data, keep_first_last_timepoint = TRUE, skip_timepoints_pattern = c(TRUE)) {
  if (keep_first_last_timepoint) {
  sliced_data <- data %>%
    dplyr::group_by(locus_name, accession) %>%
    dplyr::arrange(timepoint) %>%
    dplyr::slice(c(1, seq(2, dplyr::n() - 1, 1)[skip_timepoints_pattern], dplyr::n())) %>% 
    dplyr::ungroup()
  } else
  sliced_data <- data %>%
    dplyr::group_by(locus_name, accession) %>%
    dplyr::arrange(timepoint) %>%
    dplyr::slice(seq(1, dplyr::n(), 1)[skip_timepoints_pattern]) %>% 
    dplyr::ungroup()

  return(sliced_data)
}
```

```{r fn-undersample-data_timepoints-random}
undersample_data_timepoints_random <- function(data, num_timepoints, keep_first_timepoint = TRUE) {
  if (keep_first_timepoint) {
  sliced_data <- data %>%
    dplyr::group_by(locus_name, accession) %>%
    dplyr::arrange(timepoint) %>%
    dplyr::slice(c(1, sample(seq(2, dplyr::n(), 1), num_timepoints - 1))) %>% 
    dplyr::ungroup() %>% 
    dplyr::arrange(locus_name, accession, timepoint)
  } else {
    sliced_data <- data %>%
    dplyr::group_by(locus_name, accession) %>%
    dplyr::arrange(timepoint) %>%
    dplyr::slice(sample(seq(1, dplyr::n(), 1), num_timepoints)) %>% 
    dplyr::ungroup() %>% 
    dplyr::arrange(locus_name, accession, timepoint)
  }

  return(sliced_data)
}
```

```{r,fig.width=10, fig.height=10}
knitr::include_graphics("figure/uneven_sampled_illustration.png")
```

```{r sample-test}
alex_data_mean %>% 
  undersample_data_timepoints_random(num_timepoints = 5)
```

## Skip every one timepoint

### Plot data before registering

```{r, warning=FALSE, fig.width=10, fig.height=10}
skipped_every_one_timepoint_mean <- alex_data_mean %>% 
  undersample_data_timepoints_skip(skip_timepoints_pattern = c(FALSE, TRUE))
```
```{r}
uniq_skipped_every_one_timepoint <- skipped_every_one_timepoint_mean %>% dplyr::pull(timepoint) %>% unique()

data.frame(
"Col0" = skipped_every_one_timepoint_mean %>% dplyr::filter(accession == "Col0") %>% dplyr::pull(timepoint) %>% unique() %>% paste(collapse = ", "), 
"Ro18" = skipped_every_one_timepoint_mean %>% dplyr::filter(accession == "Ro18") %>% dplyr::pull(timepoint) %>% unique() %>% paste(collapse = ", ")
) %>% 
  t() %>% 
  as.data.frame() %>% 
  tibble::rownames_to_column() %>% 
  `colnames<-`(c("Accession", "Timepoints"))
```

```{r}
skipped_every_one_timepoint_all <- alex_data_all %>% 
  dplyr::filter(timepoint %in% uniq_skipped_every_one_timepoint)
```


### Register data

```{r error=TRUE}
reg_data_skipped_every_one_timepoint <- GREAT::scale_and_register_data(
  as.data.table(skipped_every_one_timepoint_mean),
  as.data.table(skipped_every_one_timepoint_all),
  stretches =  c(2, 1.5, 1),
  shift_extreme = 4,
  num_shifts = 27,
  min_num_overlapping_points = 2,
  initial_rescale = FALSE,
  do_rescale = TRUE,
  testing = FALSE,
  accession_data_to_transform = "Col0",
  accession_data_fix = "Ro18",
  data_to_transform_time_added = 11,
  data_fix_time_added = 11
)
```


```{r}
skipped_every_one_timepoint_mean %>% 
ggplot() +
  aes(x = timepoint, y = mean_cpm, color = accession) +
  geom_line() +
  geom_point() +
  facet_wrap(~locus_name)
```


```{r, warning=FALSE, fig.width=10, fig.height=10}
GREAT::plot_registered_GoIs_for_comparible_timepoints(reg_data_skipped_every_one_timepoint[['imputed_mean_df']])
```


## Skip every two timepoints

### Plot data before registering

```{r, warning=FALSE, fig.width=10, fig.height=10}
skipped_every_two_timepoint_mean <- alex_data_mean %>% 
  undersample_data_timepoints_skip(skip_timepoints_pattern = c(FALSE, FALSE, TRUE))
```



```{r}
uniq_skipped_every_two_timepoint_mean <- skipped_every_two_timepoint_mean %>% dplyr::pull(timepoint) %>% unique()

data.frame(
"Col0" = skipped_every_two_timepoint_mean %>% dplyr::filter(accession == "Col0") %>% dplyr::pull(timepoint) %>% unique() %>% paste(collapse = ", "), 
"Ro18" = skipped_every_two_timepoint_mean %>% dplyr::filter(accession == "Ro18") %>% dplyr::pull(timepoint) %>% unique() %>% paste(collapse = ", ")
) %>% 
  t() %>% 
  as.data.frame() %>% 
  tibble::rownames_to_column() %>% 
  `colnames<-`(c("Accession", "Timepoints"))
```

```{r include=FALSE}
skipped_every_two_timepoint_all <- alex_data_all %>% 
  dplyr::filter(timepoint %in% uniq_skipped_every_two_timepoint_mean)

# skipped_every_two_timepoint_all  %>% dplyr::pull(timepoint) %>% unique()

# skipped_every_two_timepoint_all  %>% class()

# is.data.table(skipped_every_two_timepoint_mean)
```

### Register data

```{r error=TRUE}
reg_data_skipped_every_one_timepoint <- GREAT::scale_and_register_data(
  as.data.table(skipped_every_two_timepoint_mean),
  as.data.table(skipped_every_two_timepoint_all),
  stretches =  c(2, 1.5, 1),
  shift_extreme = 4,
  num_shifts = 27,
  min_num_overlapping_points = 2,
  initial_rescale = FALSE,
  do_rescale = TRUE,
  testing = FALSE,
  accession_data_to_transform = "Col0",
  accession_data_fix = "Ro18",
  data_to_transform_time_added = 11,
  data_fix_time_added = 11
)
```

```{r}
skipped_every_two_timepoint_mean %>% 
ggplot() +
  aes(x = timepoint, y = mean_cpm, color = accession) +
  geom_line() +
  geom_point() +
  facet_wrap(~locus_name)
```


```{r, warning=FALSE, fig.width=10, fig.height=10}
GREAT::plot_registered_GoIs_for_comparible_timepoints(reg_data_skipped_every_one_timepoint[['imputed_mean_df']])
```



## Skip every three timepoints

### Plot data before registering

```{r, warning=FALSE, fig.width=10, fig.height=10}
skipped_every_three_timepoint_mean <- alex_data_mean %>% 
  undersample_data_timepoints_skip(skip_timepoints_pattern = c(FALSE, FALSE, FALSE, TRUE))
```



```{r}
uniq_skipped_every_three_timepoint <- skipped_every_three_timepoint_mean %>% dplyr::pull(timepoint) %>% unique()

data.frame(
"Col0" = skipped_every_three_timepoint_mean %>% dplyr::filter(accession == "Col0") %>% dplyr::pull(timepoint) %>% unique() %>% paste(collapse = ", "), 
"Ro18" = skipped_every_three_timepoint_mean %>% dplyr::filter(accession == "Ro18") %>% dplyr::pull(timepoint) %>% unique() %>% paste(collapse = ", ")
) %>% 
  t() %>% 
  as.data.frame() %>% 
  tibble::rownames_to_column() %>% 
  `colnames<-`(c("Accession", "Timepoints"))
```

```{r}
skipped_every_three_timepoint_all <- alex_data_all %>% 
  dplyr::filter(timepoint %in% uniq_skipped_every_three_timepoint)

# skipped_every_three_timepoint_all %>% dplyr::pull(timepoint) %>% unique()
```

### Register data

```{r error=TRUE}
reg_data_skipped_every_three_timepoint <- GREAT::scale_and_register_data(
  as.data.table(skipped_every_three_timepoint_mean),
  as.data.table(skipped_every_three_timepoint_all),
  stretches =  c(2, 1.5, 1),
  shift_extreme = 4,
  num_shifts = 27,
  min_num_overlapping_points = 1,
  initial_rescale = FALSE,
  do_rescale = TRUE,
  testing = FALSE,
  accession_data_to_transform = "Col0",
  accession_data_fix = "Ro18",
  data_to_transform_time_added = 11,
  data_fix_time_added = 11
)
```
```{r}
skipped_every_three_timepoint_mean %>% 
ggplot() +
  aes(x = timepoint, y = mean_cpm, color = accession) +
  geom_line() +
  geom_point() +
  facet_wrap(~locus_name)
```


```{r, warning=FALSE, fig.width=10, fig.height=10}
GREAT::plot_registered_GoIs_for_comparible_timepoints(reg_data_skipped_every_three_timepoint[['imputed_mean_df']])
```
