---
title: "Optimising parameters"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{optimise_parameters}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

Another feature that this package provides is option for users to optimise the parameters value while running the registration process. There are two options to do this process, if a user initialises stretch and shift factors, the optimisation process will be processed within the values initialised. If a user does not give any initialisation value, then the optimisation boundary will be automatically calculated. 

<br>

```{r opt-data-with-initial, echo=FALSE, out.width='50%'}
knitr::include_graphics("figures/optimisation_workflow_with_initialisation.png")
```

```{r opt-data-without-initial, echo=FALSE, out.width='50%'}
knitr::include_graphics("figures/optimisation_workflow_without_initialisation.png")
```

<br>

As an example, the data used on [register data](https://ruthkr.github.io/greatR/articles/register-data.html) section will be used. To do this optimisation process, we just need put parameter `optimise_registration_parameters = TRUE` when using the main function `scale_and_register_data()`. 

```{r example, message=FALSE, include=FALSE}
# Load the package
library(greatR)
library(dplyr)
```

```{r all-data, message=FALSE, warning=FALSE, include=FALSE}
# Gene expression data with replicates
all_data_df <- system.file("extdata/brapa_arabidopsis_all_replicates.csv", package = "greatR") %>%
  utils::read.csv()
```

As an example, we will use only one gene `BRAA03G023790.3C`, we can filter the data by doing:

```{r}
gene_BRAA03G023790.3C_data <- all_data_df %>% 
  dplyr::filter(locus_name == "BRAA03G023790.3C")
```


```{r register-data, message=FALSE, warning=FALSE}
# Running the registration
registration_results <- scale_and_register_data(
  input_df = gene_BRAA03G023790.3C_data,
  min_num_overlapping_points = 4,
  initial_rescale = FALSE,
  do_rescale = TRUE,
  accession_data_to_transform = "Col0",
  accession_data_ref = "Ro18",
  start_timepoint = "reference", 
  optimise_shift_extreme = FALSE,
  optimise_registration_parameters = TRUE
)

# ── Starting optimisation ────────────────────────────────────────────────────────────────────────────
# ℹ Using computed stretch boundary                    
# ℹ Using computed shift boundary                      
# ✓ Optimising registration parameters for genes (1/1) [11m 30s]
# ✓ Finished optimisation
# 
# ── Model comparison results ─────────────────────────────────────────────────────────────────────────
# ℹ BIC finds registration better than non-registration for: 1/1
# 
# ── Applying the best-shifts and stretches to gene expression ────────────────────────────────────────
# ✓ Normalising expression by mean and sd of compared values (1/1) [20ms]
# ✓ Applying best shift (1/1) [26ms]
# ℹ Max value of expression_value: 1.36
# ✓ Imputing transformed expression values (1/1) [29ms]
```

