---
title: "Visualising results"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Visualising results}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

After running registration function `scale_and_register_data()` as shown in the [registering data](https://ruthkr.github.io/greatR/articles/register-data.html) article, users can summarise and visualise the results as illustrated in the figure below.

```{r vis-reg-data, echo=FALSE, fig.align='center', out.width='80%'}
knitr::include_graphics("figures/visualisation_process.png")
```

<br>

## Get summary from registration results

The total number of registered and non-registered genes can be obtained by running function `summary_registration()` with `registration_results` as an input.

```{r load-greatR, message=FALSE, include=FALSE}
# Load the package
library(greatR)
library(data.table)
```

```{r brapa-data-results, message=FALSE, warning=FALSE, include=FALSE}
# Load a data frame from the sample data
registration_results <- system.file("extdata/brapa_arabidopsis_registration.rds", package = "greatR") |>
  readRDS()
```

Function `summary_registration()` returns a list which contains three different objects:

- `summary` contains result summaries of the registration results,
- `registered_genes` is vector of gene accessions which were successfully registered, and
- `non_registered_genes` is a vector of non-registered gene accessions.

```{r get-summary-results}
# Get registration summary
reg_summary <- summary_registration(registration_results)

reg_summary$summary |>
  knitr::kable()
```

The list of gene accessions which were registered can be viewed by calling:

```{r print-accession-of-registred-genes}
reg_summary$registered_genes
```

## Plot registration results

Function `plot_registration_results()` allows users to plot registration results of the genes of interest.

```{r plot-results, fig.align='center', fig.height=8, fig.width=7, warning=FALSE}
# Plot registration result
plot_registration_results(
  registration_results,
  ncol = 2
)
```

Notice that the plot includes a label indicating if the particular genes are registered or not, as well as the registration parameters in case the registration was successful.

## Analyse similarity of expression profiles overtime before and after registering

### Calculate sample distance

After registering the sample data, users can compare the overall similarity before and after registering using the function `calculate_distance()`.

```{r get-sample-distance}
sample_distance <- calculate_distance(registration_results)
```

Function `calculate_distance()` returns a list of two data frames:

- `registered` distance between scaled reference and query expressions using registered time points.
- `original` distance between scaled reference and query expressions using original time points.

### Plot heatmap of sample distances

Each of these data frames above can be visualised using the `plot_heatmap()` function.

```{r plot-dist-original, fig.align='center', fig.height=5, fig.width=5, warning=FALSE}
# Plot heatmap of mean expression profiles distance before registration process
plot_heatmap(
  sample_distance,
  type = "original"
)
```

```{r plot-dist-registered, fig.align='center', fig.height=5, fig.width=5, warning=FALSE}
# Plot heatmap of mean expression profiles distance after registration process
plot_heatmap(
  sample_distance,
  type = "registered",
  match_timepoints = TRUE
)
```

Notice that we use `match_timepoints = TRUE` to match registered query time points to reference time points.
